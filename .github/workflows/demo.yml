name: "Build"
on:
  push:
  schedule: # Test daily.
    - cron: 0 11 * * *

jobs:
  run-godot:
    name: ${{ matrix.os }} ${{ matrix.bits }}bit ${{ matrix.version }} ${{ matrix.mono && 'mono' || '' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        bits: [64, 32]
        mono: [true, false]
        version:
          [
            "v3.1-stable",
            "v3.1.2-stable",
            "v3.2.3-stable",
            "v3.3.4-stable",
            "v3.4-stable",
            "v3.4.1-rc3",
          ]
        exclude:
          - os: macos-latest
            bits: 32

          # Issue: https://github.com/godotengine/godot/issues/27496
          - os: ubuntu-latest
            bits: 32
            mono: false
            version: "v3.1-stable"
          - os: ubuntu-latest
            bits: 32
            mono: false
            version: "v3.1.2-stable"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Godot
        id: setup-godot
        uses: ./
        with:
          version: ${{ matrix.version }}
          bits: ${{ matrix.bits }}
          mono: ${{ matrix.mono }}
      - shell: bash
        run: godot --editor --quit

  with_alias:
    name: "with alias"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Godot with alias
        uses: ./
        with:
          alias: coolGameEngine
      - name: Run Godot with alias
        run: coolGameEngine --editor --quit
      - name: Setup Godot v3.3.2 with alias
        uses: ./
        with:
          version: 3.3.2
          alias: godot-3.3.2
      - name: Setup Godot v3.2 with alias
        uses: ./
        with:
          version: 3.2
          alias: godot-3.2
      - name: Check versions
        run: |
          godot-3.3.2 --version || true
          godot-3.2 --version || true

  no_cache:
    name: "no cache"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Godot without using cache
        uses: ./
        with:
          cache: false

  run_twice:
    name: "runs twice"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Godot
        uses: ./
      - shell: bash
        run: godot --editor --quit
      - name: Setup Godot again
        uses: ./
      - shell: bash
        run: godot --editor --quit

  x11-server:
    name: "starts X11 server"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Check X11 server not running on :0
        run: DISPLAY=:0; if ! xset -q; then exit 0; else exit 1; fi
      - name: Setup Godot
        uses: ./
      - name: Check X11 server started on :0
        run: DISPLAY=:0; if ! xset -q; then exit 1; else exit 0; fi
      - name: Check X11 server not running on :95
        run: DISPLAY=:95; if ! xset -q; then exit 0; else exit 1; fi
      - name: Set DISPLAY environment variable to :95
        uses: university-of-york/ds-devtool-setEnvVars@v1.1.1
        with:
          envFile: test/x11.env
          overwrite: true
      - name: Setup Godot again
        uses: ./
      - name: Check X11 server started on :95
        run: DISPLAY=:95; if ! xset -q; then exit 1; else exit 0; fi
