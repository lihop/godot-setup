name: "Build"
on:
  push:
  schedule: # Test daily.
    - cron: 0 10 * * *

jobs:
  run-godot:
    name: ${{ matrix.os }} ${{ matrix.arch }} ${{ matrix.version }} ${{ matrix.mono && 'mono' || '' }}
    runs-on: ${{ (matrix.arch == 'arm64' && matrix.os == 'ubuntu-latest') && 'ubuntu-24.04-arm' || (matrix.arch == 'arm64' && matrix.os == 'windows-latest') && 'windows-11-arm' || (matrix.arch == 'arm32' && matrix.os == 'ubuntu-latest') && 'ubuntu-24.04-arm' || matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-15-intel]
        arch: [x86_64, x86_32, arm64, arm32, universal]
        mono: [true, false]
        version: ["v4.3", "v4.4.1", "v4.5.1"]
        exclude:
          - os: ubuntu-latest
            arch: universal
          - os: windows-latest
            arch: universal
          - os: windows-latest
            arch: arm32
          - os: ubuntu-latest
            arch: universal
          - os: windows-latest
            arch: universal
          - os: macos-latest
            arch: x86_64
          - os: macos-latest
            arch: x86_32
          - os: macos-latest
            arch: arm64
          - os: macos-latest
            arch: arm32
          - os: macos-15-intel
            arch: x86_64
          - os: macos-15-intel
            arch: x86_32
          - os: macos-15-intel
            arch: arm64
          - os: macos-15-intel
            arch: arm32
          # mono builds don't work for Windows 32-bit (on 64-bit runner) before Godot v4.3
          - mono: true
            os: windows-latest
            arch: x86_32
            version: "v4.3"
          - mono: true
            os: windows-latest
            arch: x86_32
            version: "v4.4.1"
          # arm32 hangs on ubuntu with v4.5.1
          - os: ubuntu-latest
            arch: arm32
            version: "v4.5.1"
          # mono hangs on macos
          - os: macos-latest
            mono: true
          - os: macos-15-intel
            mono: true
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Godot
        id: setup-godot
        uses: ./
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
          mono: ${{ matrix.mono }}
          export-templates: true
      - shell: bash
        run: godot --editor ${{ matrix.os == 'windows-latest' && '--headless' || '' }} --quit
      - name: Check if export should be skipped
        id: check-export
        shell: bash
        run: |
          if [[ "${{ matrix.mono }}" == "true" && ("${{ matrix.arch }}" == "x86_32" || "${{ matrix.arch }}" == "arm32") ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Export project
        if: steps.check-export.outputs.skip != 'true'
        working-directory: test_project
        shell: bash
        run: godot --headless --export-debug ${{ matrix.os }}-${{ matrix.arch }}${{ matrix.mono && '-mono' || '' }}
      - name: Run exported project (linux)
        if: ${{ steps.check-export.outputs.skip != 'true' && matrix.os == 'ubuntu-latest' }}
        working-directory: test_project
        run: |
          ./test --rendering-driver opengl3
          grep 'Test success!' ~/.local/share/godot/app_userdata/test/test.log || grep 'Test success!' ~/.local/share/godot/app_userdata/test/logs/godot.log
      - name: Run exported project (macos)
        if: ${{ steps.check-export.outputs.skip != 'true' && (matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel') }}
        working-directory: test_project
        run: |
          volume=`hdiutil attach ./test.dmg | grep Volumes | awk '{print $3}'`
          cp -rf $volume/*.app /Applications
          hdiutil detach $volume
          /Applications/test.app/Contents/MacOS/test --rendering-driver opengl3
          sleep 2
          grep 'Test success!' ~/Library/Application\ Support/Godot/app_userdata/test/test.log || grep 'Test success!' ~/Library/Application\ Support/Godot/app_userdata/test/logs/godot.log
      - name: Run exported project (windows)
        if: ${{ steps.check-export.outputs.skip != 'true' && matrix.os == 'windows-latest' }}
        working-directory: test_project
        run: .\test.exe -and Select-String -Path "$env:Appdata\Godot\app_userdata\test\test.log" -Pattern "Test success!"

  with_alias:
    name: "with alias"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Godot with alias
        uses: ./
        with:
          alias: coolGameEngine
      - name: Run Godot with alias
        run: coolGameEngine --editor --quit
      - name: Setup Godot v4.4.1 with alias
        uses: ./
        with:
          version: 4.4.1
          alias: godot-4.4.1
      - name: Setup Godot v4.3 with alias
        uses: ./
        with:
          version: 4.3
          alias: godot-4.3
      - name: Check versions
        run: |
          godot-4.4.1 --version || true
          godot-4.3 --version || true

  no_cache:
    name: "no cache"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Godot without using cache
        uses: ./
        with:
          cache: false

  run_twice:
    name: "runs twice"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          # Windows hangs.
          - os: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Godot
        uses: ./
      - shell: bash
        run: godot --editor --quit
      - name: Setup Godot again
        uses: ./
      - shell: bash
        run: godot --editor --quit

  x11-server:
    name: "starts X11 server"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Set DISPLAY environment variable to :0
        run: echo "DISPLAY=:0" >> $GITHUB_ENV
      - name: Check X11 server not running on :0
        run: if ! xset -q; then exit 0; else exit 1; fi
      - name: Setup Godot
        uses: ./
      - name: Check X11 server started on :0
        run: if ! xset -q; then exit 1; else exit 0; fi
      - name: Set DISPLAY environment variable to :95
        run: echo "DISPLAY=:95" >> $GITHUB_ENV
      - name: Check X11 server not running on :95
        run: if ! xset -q; then exit 0; else exit 1; fi
      - name: Setup Godot again
        uses: ./
      - name: Check X11 server started on :95
        run: if ! xset -q; then exit 1; else exit 0; fi

  export-html5:
    name: Export HTML5 (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.version }}, ${{ matrix.mono && 'mono, ' || '' }}${{ matrix.export-type }})
    runs-on: ${{ (matrix.arch == 'arm64' && matrix.os == 'ubuntu-latest') && 'ubuntu-24.04-arm' || (matrix.arch == 'arm64' && matrix.os == 'windows-latest') && 'windows-2022-arm64' || (matrix.arch == 'arm32' && matrix.os == 'ubuntu-latest') && 'ubuntu-24.04-arm' || matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [x86_64, universal]
        export-type: [regular, threads, gdnative]
        version: ["v4.3-stable"]
        exclude:
          - os: ubuntu-latest
            arch: universal
          - os: macos-latest
            arch: x86_64
          - os: windows-latest
            arch: universal
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Godot
        uses: ./
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
          export-templates: true
      - name: Export HTML5 (${{ matrix.export-type }})
        shell: bash
        working-directory: test_project
        run: |
          preset="html5-${{ matrix.export-type }}"
          case "$preset" in
            html5-regular)
              output="export/html5-regular/index.html"
              ;;
            html5-threads)
              output="export/html5-threads/index.html"
              ;;
            html5-gdnative)
              output="export/html5-gdnative/index.html"
              ;;
            *)
              echo "Unknown HTML5 export preset '$preset'"
              exit 1
              ;;
          esac
          godot --headless --export-release "$preset" "$output"
